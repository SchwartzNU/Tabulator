{% extends 'base.html' %}
{% block content %}
  <div class="two-col">
    <div class="cards" id="left-column">
      <!-- Upload Card -->
      <section class="card" id="upload-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="upload-body">
          <span class="chevron">▾</span>
          <span class="card-title">Upload Data Table</span>
        </button>
      </div>
      <div class="card-body" id="upload-body">
        <p>Load a dataset into Tabulator by uploading a file or connecting directly to a database.</p>
        <div class="mode-switch" role="tablist" aria-label="Data source">
          <button type="button" class="mode-switch-btn active" role="tab" aria-selected="true" data-target="upload-mode-file">Upload File</button>
          <button type="button" class="mode-switch-btn" role="tab" aria-selected="false" data-target="upload-mode-db">From Database</button>
        </div>

        <div id="upload-mode-file" class="mode-panel">
          <p class="muted-note">Accepted formats: .csv, .h5, .pkl/.pickle, .mat</p>
          <form id="uploadForm" action="{{ url_for('main.upload') }}" method="post" enctype="multipart/form-data">
            <input type="file" id="datafile" name="datafile" accept=".csv,.h5,.pkl,.pickle,.mat" />
            <button type="submit">Upload</button>
          </form>
        </div>

        <div id="upload-mode-db" class="mode-panel" hidden>
          <p class="muted-note">
            Tabulator will connect to the lab database using stored credentials and the DataJoint client.
          </p>
          <div class="db-credentials-hint">
            <div><strong>Host:</strong> {{ db_host or 'Configured in .env' }}</div>
            <div><strong>User:</strong> {{ db_user or 'Configured in .env' }}</div>
            <div><strong>Schema:</strong> {{ db_schema or 'sln_results (default)' }}</div>
          </div>
          <div class="form-row db-table-picker">
            <span class="field stretch">
              <label for="db-table-select">Table</label>
              <select id="db-table-select" disabled>
                <option>Switch to this tab to load tables…</option>
              </select>
            </span>
          </div>
          <div class="form-row db-query-picker">
            <span class="field stretch">
              <label for="db-user-query">User Query</label>
              <select id="db-user-query" disabled>
                <option value="">All users</option>
              </select>
            </span>
            <span class="field stretch">
              <label for="db-project-query">Project Query</label>
              <select id="db-project-query" disabled>
                <option value="">All projects</option>
              </select>
            </span>
          </div>
          <div class="form-row" style="margin-top:12px;">
            <button type="button" id="db-load-btn">Load Table</button>
            <span id="db-load-status" class="muted-note" role="status" aria-live="polite"></span>
          </div>
        </div>
      </div>
      </section>

      {% if dataset_id and info %}
      <!-- Current Dataset Card -->
      <section class="card" id="dataset-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="dataset-body">
          <span class="chevron">▾</span>
          <span class="card-title">Current Dataset</span>
        </button>
      </div>
      <div class="card-body" id="dataset-body">
        <div class="dataset-meta">
          <div><strong>ID:</strong> {{ dataset_label or dataset_id }}</div>
          {% if dataset_source %}
            <div><strong>Source:</strong>
              {% if dataset_source == 'upload' %}
                Uploaded file
              {% else %}
                {{ dataset_source }}
              {% endif %}
            </div>
          {% endif %}
          <div><strong>Shape:</strong> {{ info.rows }} rows × {{ info.cols }} cols</div>
          <details class="columns-details">
            <summary>Columns ({{ info.cols }})</summary>
            <div class="columns-list">
              {% for c in info.columns %}
                <span class="col-chip" title="{{ c }}">{{ c }}</span>
              {% endfor %}
            </div>
          </details>
        </div>
        {% if preview_html %}
          <details class="preview-details">
            <summary>Preview (first 10 rows)</summary>
            <div class="table-preview">{{ preview_html | safe }}</div>
          </details>
        {% endif %}
          {% if units_items %}
          <details class="units-details">
            <summary>Units / Description</summary>
            <div class="table-preview units-table-wrap">
              <table>
                <thead><tr><th>Variable</th><th>Units / Description</th></tr></thead>
                <tbody>
                  {% for k, u in units_items %}
                    <tr><td>{{ k }}</td><td>{{ u }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </details>
        {% endif %}
      </div>
      </section>
      {% endif %}

      <!-- Plots Card (container with Add Plot) -->
      <section class="card" id="plots-card">
        <div class="card-header">
          <button class="card-toggle" aria-expanded="true" aria-controls="plots-body">
            <span class="chevron">▾</span>
            <span class="card-title">Plots</span>
          </button>
          <div class="card-actions">
            <button id="add-plot-btn" type="button">Add Plot</button>
          </div>
        </div>
        <div class="card-body" id="plots-body">
          <div id="plots-container" class="cards"></div>
        </div>
      </section>
    </div>

    <div class="cards" id="right-column">
      {% if dataset_id and info %}
      <!-- PCA Card -->
      <section class="card" id="pca-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="pca-body">
          <span class="chevron">▾</span>
          <span class="card-title">Principal Components Analysis (PCA)</span>
        </button>
        <div class="card-actions">
          <button id="run-pca-btn" type="button">Run PCA</button>
        </div>
      </div>
      <div class="card-body" id="pca-body">
        <div id="pca-preview" class="plot-preview"></div>
        <div id="pca-controls" class="form-row" style="margin-top:8px; display: none;">
          <span class="field">
            <label for="pca-loadings-pc">Loadings for</label>
            <select id="pca-loadings-pc"></select>
          </span>
        </div>
        <div id="pca-loadings" class="plot-preview"></div>
        <div id="pca-scatter-controls" class="form-row" style="margin-top:8px; display: none;">
          <span class="field">
            <label for="pca-dim">Plot</label>
            <select id="pca-dim">
              <option value="2d">2D</option>
              <option value="3d">3D</option>
            </select>
          </span>
          <span class="field">
            <label for="pca-pc-x">PC X</label>
            <select id="pca-pc-x"></select>
          </span>
          <span class="field">
            <label for="pca-pc-y">PC Y</label>
            <select id="pca-pc-y"></select>
          </span>
          <span class="field" id="pca-pc-z-field" style="display:none;">
            <label for="pca-pc-z">PC Z</label>
            <select id="pca-pc-z"></select>
          </span>
          <span class="field">
            <label for="pca-color">Color by</label>
            <select id="pca-color">
              <option value="">None</option>
            </select>
          </span>
        </div>
        <div id="pca-scatter" class="plot-preview"></div>
        <div id="pca-info" style="color: var(--muted); font-size: 12px; margin-top: 6px;"></div>
      </div>
      </section>
      {% endif %}

      {% if dataset_id and info %}
      <!-- Clustering and Dimensionality Reduction Card -->
      <section class="card" id="dr-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="dr-body">
          <span class="chevron">▾</span>
          <span class="card-title">Clustering and Dimensionality Reduction</span>
        </button>
        <div class="card-actions">
          <button id="run-dr-btn" type="button">Run</button>
        </div>
      </div>
      <div class="card-body" id="dr-body">
        <div class="form-row">
          <span class="field">
            <label for="dr-method">Method</label>
            <select id="dr-method">
              <option value="tsne">t-SNE</option>
              <option value="umap">UMAP</option>
            </select>
          </span>
          <span class="field">
            <label for="dr-mode">Features</label>
            <select id="dr-mode">
              <option value="all">All numeric columns</option>
              <option value="pcs">First N PCs</option>
            </select>
          </span>
          <span class="field">
            <label for="dr-npcs">N</label>
            <input id="dr-npcs" type="number" min="1" value="10" style="width:80px;" />
          </span>
          <span class="field">
            <label for="dr-color">Color by</label>
            <select id="dr-color">
              <option value="">None</option>
            </select>
          </span>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <span class="field">
            <label for="dr-cluster">Clustering</label>
            <select id="dr-cluster">
              <option value="none">None</option>
              <option value="kmeans">KMeans</option>
              <option value="dbscan">DBSCAN</option>
              <option value="agglomerative">Agglomerative</option>
              <option value="hdbscan">HDBSCAN</option>
            </select>
          </span>
          <span id="dr-kmeans-params" class="field">
            <label for="dr-kmeans-k">k</label>
            <input id="dr-kmeans-k" type="number" min="2" value="5" style="width:80px;" />
          </span>
          <span id="dr-dbscan-params">
            <span class="field">
              <label for="dr-dbscan-eps">eps</label>
              <input id="dr-dbscan-eps" type="number" min="0" step="any" value="0.5" style="width:90px;" />
            </span>
            <span class="field">
              <label for="dr-dbscan-min">min_samples</label>
              <input id="dr-dbscan-min" type="number" min="1" value="5" style="width:90px;" />
            </span>
          </span>
          <span id="dr-agglom-params">
            <span class="field">
              <label for="dr-agglom-k">k</label>
              <input id="dr-agglom-k" type="number" min="2" value="5" style="width:80px;" />
            </span>
            <span class="field">
              <label for="dr-agglom-linkage">linkage</label>
              <select id="dr-agglom-linkage">
                <option value="ward">ward</option>
                <option value="average">average</option>
                <option value="complete">complete</option>
              </select>
            </span>
          </span>
          <span id="dr-hdbscan-params">
            <span class="field">
              <label for="dr-hdbscan-minsize">min_cluster_size</label>
              <input id="dr-hdbscan-minsize" type="number" min="2" value="10" style="width:110px;" />
            </span>
            <span class="field">
              <label for="dr-hdbscan-minsamples">min_samples</label>
              <input id="dr-hdbscan-minsamples" type="number" min="1" value="5" style="width:110px;" />
            </span>
          </span>
        </div>
        <div id="dr-preview" class="plot-preview" style="margin-top:8px;"></div>
        <div id="dr-info" style="color: var(--muted); font-size: 12px; margin-top: 6px;"></div>
      </div>
      </section>
      {% endif %}

      {% if dataset_id and info %}
      <!-- Classifier Card -->
      <section class="card" id="clf-card">
        <div class="card-header">
          <button class="card-toggle" aria-expanded="true" aria-controls="clf-body">
            <span class="chevron">▾</span>
            <span class="card-title">Classifier</span>
          </button>
          <div class="card-actions">
            <button id="clf-train-btn" type="button">Train</button>
          </div>
        </div>
        <div class="card-body" id="clf-body">
          <div class="form-row">
            <span class="field">
              <label for="clf-label-col">Labels</label>
              <select id="clf-label-col"></select>
            </span>
            <span class="field">
              <label for="clf-type">Classifier</label>
              <select id="clf-type">
                <option value="svm">SVM (linear)</option>
                <option value="logistic">Logistic</option>
                <option value="decision_tree">Decision Tree</option>
                <option value="random_forest">Random Forest</option>
                <option value="neural_net">Neural Net</option>
              </select>
            </span>
            <span class="field">
              <label for="clf-test-frac">Test fraction</label>
              <input id="clf-test-frac" type="number" min="0.05" max="0.5" step="0.05" value="0.2" />
            </span>
            <span class="field">
              <label for="clf-iters">Iterations</label>
              <input id="clf-iters" type="number" min="1" max="500" step="1" value="50" />
            </span>
            <span class="field">
              <label class="toggle" for="clf-early"><input id="clf-early" type="checkbox" checked /> Early stop</label>
            </span>
            <span class="field">
              <label for="clf-patience">Patience</label>
              <input id="clf-patience" type="number" min="1" max="50" step="1" value="5" />
            </span>
          </div>
          <div id="clf-learning" class="plot-preview" style="margin-top:8px;"></div>
          <div id="clf-metrics" style="color: var(--muted); font-size: 12px; margin-top: 6px;"></div>
          <div id="clf-confusion" class="plot-preview" style="margin-top:8px;"></div>
        </div>
      </section>
      {% endif %}
    </div>
  </div>
{% endblock %}
