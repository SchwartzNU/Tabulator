{% extends 'base.html' %}
{% block content %}
  <div class="cards">
    <!-- Upload Card -->
    <section class="card" id="upload-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="upload-body">
          <span class="chevron">▾</span>
          <span class="card-title">Upload Data Table</span>
        </button>
      </div>
      <div class="card-body" id="upload-body">
        <p>Accepted formats: .csv, .h5, .pkl/.pickle, .mat</p>
        <form id="uploadForm" action="{{ url_for('main.upload') }}" method="post" enctype="multipart/form-data">
          <input type="file" id="datafile" name="datafile" accept=".csv,.h5,.pkl,.pickle,.mat" />
          <button type="submit">Upload</button>
        </form>
      </div>
    </section>

    {% if dataset_id and info %}
    <!-- Current Dataset Card -->
    <section class="card" id="dataset-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="dataset-body">
          <span class="chevron">▾</span>
          <span class="card-title">Current Dataset</span>
        </button>
      </div>
      <div class="card-body" id="dataset-body">
        <div class="dataset-meta">
          <div><strong>ID:</strong> {{ dataset_id }}</div>
          <div><strong>Shape:</strong> {{ info.rows }} rows × {{ info.cols }} cols</div>
          <details class="columns-details">
            <summary>Columns ({{ info.cols }})</summary>
            <div class="columns-list">
              {% for c in info.columns %}
                <span class="col-chip" title="{{ c }}">{{ c }}</span>
              {% endfor %}
            </div>
          </details>
        </div>
        {% if preview_html %}
          <details class="preview-details">
            <summary>Preview (first 10 rows)</summary>
            <div class="table-preview">{{ preview_html | safe }}</div>
          </details>
        {% endif %}
        {% if units_items %}
          <details class="units-details">
            <summary>Units</summary>
            <div class="table-preview units-table-wrap">
              <table>
                <thead><tr><th>Variable</th><th>Unit</th></tr></thead>
                <tbody>
                  {% for k, u in units_items %}
                    <tr><td>{{ k }}</td><td>{{ u }}</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </details>
        {% endif %}
      </div>
    </section>
    {% endif %}

    {% if dataset_id and info %}
    <!-- PCA Card -->
    <section class="card" id="pca-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="pca-body">
          <span class="chevron">▾</span>
          <span class="card-title">Principal Components Analysis (PCA)</span>
        </button>
        <div class="card-actions">
          <button id="run-pca-btn" type="button">Run PCA</button>
        </div>
      </div>
      <div class="card-body" id="pca-body">
        <div id="pca-preview" class="plot-preview"></div>
        <div id="pca-controls" class="form-row" style="margin-top:8px; display: none;">
          <label for="pca-loadings-pc">Loadings for</label>
          <select id="pca-loadings-pc"></select>
        </div>
        <div id="pca-loadings" class="plot-preview"></div>
        <div id="pca-info" style="color: var(--muted); font-size: 12px; margin-top: 6px;"></div>
      </div>
    </section>
    {% endif %}

    {% if dataset_id and info %}
    <!-- Clustering and Dimensionality Reduction Card -->
    <section class="card" id="dr-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="dr-body">
          <span class="chevron">▾</span>
          <span class="card-title">Clustering and Dimensionality Reduction</span>
        </button>
        <div class="card-actions">
          <button id="run-dr-btn" type="button">Run</button>
        </div>
      </div>
      <div class="card-body" id="dr-body">
        <div class="form-row">
          <label for="dr-method">Method</label>
          <select id="dr-method">
            <option value="tsne">t-SNE</option>
            <option value="umap">UMAP</option>
          </select>
          <label for="dr-mode">Features</label>
          <select id="dr-mode">
            <option value="all">All numeric columns</option>
            <option value="pcs">First N PCs</option>
          </select>
          <label for="dr-npcs">N</label>
          <input id="dr-npcs" type="number" min="1" value="10" style="width:80px;" />
          <label for="dr-color">Color by</label>
          <select id="dr-color">
            <option value="">None</option>
          </select>
        </div>
        <div class="form-row" style="margin-top:8px;">
          <label for="dr-cluster">Clustering</label>
          <select id="dr-cluster">
            <option value="none">None</option>
            <option value="kmeans">KMeans</option>
            <option value="dbscan">DBSCAN</option>
            <option value="agglomerative">Agglomerative</option>
            <option value="hdbscan">HDBSCAN</option>
          </select>
          <span id="dr-kmeans-params">
            <label for="dr-kmeans-k">k</label>
            <input id="dr-kmeans-k" type="number" min="2" value="5" style="width:80px;" />
          </span>
          <span id="dr-dbscan-params">
            <label for="dr-dbscan-eps">eps</label>
            <input id="dr-dbscan-eps" type="number" min="0" step="any" value="0.5" style="width:90px;" />
            <label for="dr-dbscan-min">min_samples</label>
            <input id="dr-dbscan-min" type="number" min="1" value="5" style="width:90px;" />
          </span>
          <span id="dr-agglom-params">
            <label for="dr-agglom-k">k</label>
            <input id="dr-agglom-k" type="number" min="2" value="5" style="width:80px;" />
            <label for="dr-agglom-linkage">linkage</label>
            <select id="dr-agglom-linkage">
              <option value="ward">ward</option>
              <option value="average">average</option>
              <option value="complete">complete</option>
            </select>
          </span>
          <span id="dr-hdbscan-params">
            <label for="dr-hdbscan-minsize">min_cluster_size</label>
            <input id="dr-hdbscan-minsize" type="number" min="2" value="10" style="width:110px;" />
            <label for="dr-hdbscan-minsamples">min_samples</label>
            <input id="dr-hdbscan-minsamples" type="number" min="1" value="5" style="width:110px;" />
          </span>
        </div>
        <div id="dr-preview" class="plot-preview" style="margin-top:8px;"></div>
        <div id="dr-info" style="color: var(--muted); font-size: 12px; margin-top: 6px;"></div>
      </div>
    </section>
    {% endif %}

    <!-- Plots Card (container with Add Plot) -->
    <section class="card" id="plots-card">
      <div class="card-header">
        <button class="card-toggle" aria-expanded="true" aria-controls="plots-body">
          <span class="chevron">▾</span>
          <span class="card-title">Plots</span>
        </button>
        <div class="card-actions">
          <button id="add-plot-btn" type="button">Add Plot</button>
        </div>
      </div>
      <div class="card-body" id="plots-body">
        <div id="plots-container" class="cards"></div>
      </div>
    </section>
  </div>
{% endblock %}
